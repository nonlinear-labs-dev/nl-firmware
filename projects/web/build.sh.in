set -e

ln -s /builddir /home/bob-the-builder
useradd -u ${USER_ID} bob-the-builder

BOBS_SCRIPT=$(cat <<'END_HEREDOC'
set -e

export PATH=/home/bob-the-builder/.meteor/:$PATH

cd ~/meteor-build/

rm -rf ./client
rm -rf ./public

mkdir /tmp/client
tar -xf /builddir/core/bundle.tar.gz -C /tmp/client

mkdir /tmp/client/c16-hwui
tar -xf /builddir/c16-hwui/bundle.tar.gz -C /tmp/client/c16-hwui

# static html projects
mkdir /tmp/public
for project in  nonmaps recorder online-help mc-view; do
  mkdir /tmp/public/$project
  tar -xf /builddir/$project/bundle.tar.gz -C /tmp/public/$project
done

ln -s /builddir/build-time-info.js /tmp/client/build-time-info.js
ln -s /tmp/client ~/meteor-build/client 
ln -s /tmp/public ~/meteor-build/public

node ./node_modules/meteor-build-client/main.js /builddir/web/out

END_HEREDOC
)

runuser -l bob-the-builder -c "$BOBS_SCRIPT"

