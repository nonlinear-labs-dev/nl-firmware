#!/bin/sh
# version : 2.0

freeze() {
    while true; do
        sleep 1
    done
}

unpack_update() {
    @C15_INSTALL_PATH@/text2soled/text2soled multitext "Copying C15 update...@SC1" "DO NOT SWITCH OFF!@SC2" "Copying C15 update...@BC2" "DO NOT SWITCH OFF!@BC3"
    if rm -rf /update \
        && mkdir -p /update \
        && cp /mnt/usb-stick/nonlinear-c15-update.tar /update \
        && cd /update;
    then
      @C15_INSTALL_PATH@/text2soled/text2soled multitext "Unpacking C15 update...@SC1" "DO NOT SWITCH OFF!@SC2" "Unpacking C15 update...@BC2" "DO NOT SWITCH OFF!@BC3"
      if tar xf nonlinear-c15-update.tar; then
        return 0
      fi
    fi
    @C15_INSTALL_PATH@/text2soled/text2soled multitext "Update Media Error.@SC1" "Please retry@SC2" "Update Media Error.@BC2" "Please retry@BC3"
    sleep 2
    return 1
}

check_preconditions() {
    if ! ls -l /update/BBB/ | grep bbb_update_1811a.sh \
        && ! ls -l /update/BBB/ | grep bbb_update_1905a.sh \
        && ! ls -l /update/BBB/ | grep playground-RELEASE-2019-05-1.5-706569a; then
            return 0
    fi
    rm -rf /update/*
    return 1
}

run_update() {
    chmod +x /update/run.sh
    /bin/sh /update/run.sh && mv /mnt/usb-stick/nonlinear-c15-update.tar /mnt/usb-stick/nonlinear-c15-update.tar-copied
    freeze
}


main() {
    if [ -e /mnt/usb-stick/nonlinear-c15-update.tar ]; then
        unpack_update && check_preconditions && run_update
    fi
    return 0
}

main
